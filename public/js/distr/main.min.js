class Authenticate{constructor(){this.login=document.getElementById("login"),this.pass1=document.getElementById("pass1"),this.pass2=document.getElementById("pass2"),this.authBtn=document.getElementById("authenticate-bt"),this.login.onclick=()=>{this.login.style.borderColor="transparent"},this.pass1.onclick=()=>{this.pass1.style.borderColor="transparent"},this.pass2.onclick=()=>{this.pass2.style.borderColor="transparent"},this.authBtn.onclick=()=>{this.authenticate()}}async authenticate(){if(!this.login.value)return alert('Поле "Логин" пусто. Придумайте себе логин, чтобы продолжить.'),void(this.login.style.borderColor="#f26a6a");if(!this.pass1.value)return alert('Поле "Пароль" пусто. Придумайте себе пароль, чтобы продолжить.'),void(this.pass1.style.borderColor="#f26a6a");if(!this.pass2.value)return alert('Поле "Пароль повторно" пусто. Введите пароль повторно, чтобы продолжить.'),void(this.pass2.style.borderColor="#f26a6a");if(this.pass1.value!==this.pass2.value)return void alert("Введённые Вами пароли не совпадают");const t={login:this.login.value,pass1:this.pass1.value,pass2:this.pass2.value},e=await request("/authenticate","POST",t);if("Inconsistent data"!=e.statusText)return"Duplicate"==e.statusText?void alert("Такой логин уже занят, придумайте другой"):"Passwords mismatch"==e.statusText?void alert("Пароли не совпадают"):"Authenticated"==e.statusText?(alert("Аутентификация успешна, сейчас вы будете перенаправлены на страницу логина"),void(window.location.href="/auth")):void alert("Ошибка аутентификации");alert("Отсутсвует логин или пароль")}}class Authorisate{constructor(){this.authBtn=document.getElementById("auth-bt"),this.loginInpt=document.getElementById("login"),this.passInpt=document.getElementById("pass"),this.authBtn.onclick=()=>{this.authorise()}}async authorise(){if(!this.loginInpt.value||!this.passInpt.value)return alert("Отсутствует логин или пароль");const t={login:this.loginInpt.value,pass:this.passInpt.value},e=await request("/auth","POST",t);return"Check login and password"==e.statusText?void alert("Неверный логин или пароль"):"Authorised"==e.statusText?(alert("Авторизация успешна и будет действительна в течение 30 дней"),void(window.location.href="/performances")):void alert("Произошла ошибка во время авторизации")}}class Performance{constructor(t="",e="false"){this.edit=e,this.pointsData={leftSide:{},rightSide:{}},this.totalPointsNum=0,this.addPerfBtn=document.getElementById("add-performance-btn"),this.preloader=document.getElementById("preloader"),this.searchInpt=document.getElementById("search-perfs"),this.backgroundModal=document.getElementById("background-modal"),this.closeAddPerf=document.getElementById("close-adding-perf"),this.savePerfBtn=document.getElementById("save-perf-btn"),this.perfName=document.getElementById("perf-name"),this.perfType=document.getElementById("perf-type"),this.perfUrl=document.getElementById("perf-pic-url"),this.perfActs=document.getElementById("perf-acts"),this.perfPoints=document.getElementById("perf-points"),this.perfNotes=document.getElementById("perf-notes"),this.addActBtn=document.getElementById("add-act"),this.searchResults=document.getElementById("search-results"),this.closeCardPerf=document.getElementById("close-card-perf"),this.backgroundCard=document.getElementById("card-back"),this.addPointsBtn=document.getElementById("add-points"),this.addRightPointBtn=document.getElementById("add-right-pt-btn"),this.addLeftPointBtn=document.getElementById("add-left-pt-btn"),this.backgroundPoints=document.getElementById("points-back"),this.closeEditPointsBtn=document.getElementById("close-points-perf"),this.userPointsBack=document.getElementById("user-points-back"),this.closeUserPoints=document.getElementById("close-user-points"),this.cardPerfName=document.getElementById("card-perf-name"),this.cardPerfImg=document.getElementById("card-perf-img"),this.cardPerfType=document.getElementById("card-perf-type"),this.cardPerfActs=document.getElementById("card-perf-acts"),this.cardPerfPoints=document.getElementById("card-perf-points"),this.cardPerfNotes=document.getElementById("card-perf-notes"),this.totalPointsSpan=document.getElementById("total-points-num"),"true"===this.edit&&(this.addPerfBtn.onclick=()=>{this.backgroundModal.style.display="block"},this.closeAddPerf.onclick=()=>{this.backgroundModal.style.display="none"},this.savePerfBtn.onclick=()=>{this.save(!1,"create")},this.perfName.onclick=()=>{this.perfName.style.borderColor="initial"},this.perfType.onclick=()=>{this.perfType.style.borderColor="initial"},this.addActBtn.onclick=()=>{this.addAct()},this.addRightPointBtn.onclick=()=>{this.addPoint("right")},this.addLeftPointBtn.onclick=()=>{this.addPoint("left")}),this.closeEditPointsBtn.onclick=()=>{this.saveEditingPoints()},this.addPointsBtn.onclick=()=>{this.backgroundPoints.style.display="block",window.scrollTo(0,0)},this.closeCardPerf.onclick=()=>{this.savePerfBtn.onclick=()=>{this.save(!1,"create")},this.backgroundCard.style.display="none"},this.closeUserPoints.onclick=()=>{this.userPointsBack.style.display="none"},this.searchInpt.oninput=()=>{this.searchInpt.value&&""!=this.searchInpt.value?this.clearDomElement(this.searchResults,async()=>{if(/^\s*$/.test(this.searchInpt.value))this.fillSearchResults([]);else{const t={query:this.searchInpt.value};this.preloader.style.display="block";const e=await request("/perf-search","POST",t);if("OK"==e.statusText){const t=await e.json();this.fillSearchResults(t.perfs),this.preloader.style.display="none"}else{if("error"===e)return this.preloader.style.display="none";if("econn"==e){this.preloader.style.display="none";const t=document.createElement("div");t.setAttribute("class","perf-name-found nothing-found"),t.textContent="Проверьте интернет соединение",this.searchResults.childNodes[0]||this.searchResults.appendChild(t)}}}}):setTimeout(()=>{this.clearDomElement(this.searchResults,()=>{})},100)}}getActsEnding=t=>1==t?t+" акт":t>1&&t<5?t+" акта":t+"актов";showPerformanceCard=()=>{this.backgroundCard.style.display="block",window.scrollTo(0,0)};showUsualPointsTable=()=>{this.userPointsBack.style.display="block",window.scrollTo(0,0)};clearDomElement=(t,e)=>{for(;t.firstChild;)t.firstChild.remove();return e()};fillCardPerformanceActs=(t,e)=>{"ballet"===t?this.cardPerfType.textContent="Балет, "+this.getActsEnding(e.length):"opera"===t&&(this.cardPerfType.textContent="Опера, "+this.getActsEnding(e.length)),this.clearDomElement(this.cardPerfActs,()=>{for(let t=0;t<e.length;t++){let i=document.createElement("div"),n=document.createElement("span"),s=document.createElement("span");i.setAttribute("class","act-line"),n.textContent=t+1+" Акт:",s.textContent=""+e[t],i.appendChild(n),i.appendChild(s),this.cardPerfActs.appendChild(i)}})};fillCardPerformancePoints=t=>{if(t){2==this.cardPerfPoints.childNodes.length?this.cardPerfPoints.childNodes[1].remove():3==this.cardPerfPoints.childNodes.length&&(this.cardPerfPoints.childNodes[1].remove(),this.cardPerfPoints.childNodes[1].remove());const e=document.createElement("p");e.setAttribute("class","total-points-usr"),e.textContent=`Всего: ${this.countPointsNum(t)} шт.`,this.cardPerfPoints.appendChild(e),this.fillUserPointsTable(t);const i=document.createElement("button");i.setAttribute("class","showPoints-btn"),i.textContent="Просмотр",i.onclick=()=>{this.userPointsBack.style.height=this.backgroundCard.offsetHeight+"px",this.showUsualPointsTable()},this.cardPerfPoints.appendChild(i)}else if(3==this.cardPerfPoints.childNodes.length){this.cardPerfPoints.childNodes[1].remove(),this.cardPerfPoints.childNodes[1].remove();const t=document.createElement("i");t.textContent="– Отсутствуют",this.cardPerfPoints.appendChild(t)}};fillPerformanceCard=t=>{if(this.cardPerfName.textContent=t.name,t.imgUrl?(this.cardPerfImg.src=window.location.origin+"/static/imgs/performance-imgs/"+t.imgUrl,this.cardPerfImg.style.display="inline-block"):(this.cardPerfImg.src=window.location.origin+"/static/imgs/performance-imgs/no-photo.png",this.cardPerfImg.style.display="inline-block"),this.fillCardPerformanceActs(t.type,t.acts),this.fillCardPerformancePoints(t.points),""!=t.notes?this.cardPerfNotes.innerHTML=t.notes:this.cardPerfNotes.textContent="– Отсутствуют","true"===this.edit){let e=document.createElement("button");e.setAttribute("class","edit-btn"),e.textContent="Редактировать",e.onclick=()=>{this.openEdit(t)};let i=document.createElement("button");i.setAttribute("class","rm-perf-btn"),i.textContent="Удалить",i.onclick=()=>{confirm(`Вы действительно хотите удалить спектакль "${t.name}" из базы?`)&&this.save(t._id,"remove")},4==this.cardPerfName.parentElement.childNodes.length?(this.cardPerfName.parentElement.appendChild(e),this.cardPerfName.parentElement.appendChild(i)):(this.cardPerfName.parentElement.childNodes[4].remove(),this.cardPerfName.parentElement.childNodes[4].remove(),this.cardPerfName.parentElement.appendChild(e),this.cardPerfName.parentElement.appendChild(i))}this.savePerfBtn.onclick=()=>{this.save(t._id,"update")}};fillSearchResults=t=>{if(0==t.length){const t=document.createElement("div");t.setAttribute("class","perf-name-found nothing-found"),t.textContent="Ничего не найдено",this.searchResults.childNodes[0]||this.searchResults.appendChild(t)}else for(let e=0;e<t.length;e++){let i=document.createElement("div");i.setAttribute("class","perf-name-found"),i.textContent=t[e].name,i.onclick=()=>{this.fillPerformanceCard(t[e]),this.showPerformanceCard()};for(let t=0;t<this.searchResults.childNodes.length;t++)if(this.searchResults.childNodes[t].textContent==i.textContent)return;this.searchResults.appendChild(i)}};openEdit=t=>{if(this.pointsData=t.points,this.backgroundCard.style.display="none",this.backgroundModal.style.display="block",this.perfName.value=t.name,this.perfType.value=t.type,this.perfUrl.value=t.imgUrl,t.acts.length>0){let e,i,n,s,l;this.perfActs.innerHTML="";for(let r=0;r<t.acts.length;r++)e=document.createElement("div"),e.setAttribute("class","act-line"),i=document.createElement("span"),i.setAttribute("class","perf-act"),i.textContent=r+1+":",e.appendChild(i),n=document.createElement("input"),n.setAttribute("class","act-time"),n.setAttribute("type","text"),n.setAttribute("placeholder","1ч 15мин"),n.value=t.acts[r],e.appendChild(n),0==r?(l=document.createElement("button"),l.setAttribute("class","add-mini-btn"),l.textContent="+",l.onclick=()=>{this.addAct()},e.appendChild(l)):(s=document.createElement("span"),s.setAttribute("class","del-act-btn"),s.textContent="X",s.onclick=t=>{t.target.parentElement.remove()},e.appendChild(s)),this.perfActs.appendChild(e);this.fillEditCardPointsDiv(t.points),this.fillPointsEditModal(t.points),this.perfNotes.value=t.notes,this.savePerfBtn.textContent="Сохранить изменения",this.savePerfBtn.onclick=()=>{this.save(t._id,"update")}}};fillEditCardPointsDiv=t=>{if(t){this.perfPoints.childNodes[0].remove(),this.perfPoints.childNodes[0].remove();let e=document.createElement("span");e.setAttribute("class","points-number"),e.textContent=this.countPointsNum(t)+" шт.";let i=document.createElement("span");i.setAttribute("class","showPoints-btn"),i.textContent="Редактор",i.onclick=()=>{this.fillPointsEditModal(t),this.backgroundPoints.style.height=this.backgroundModal.offsetHeight+"px",this.backgroundPoints.style.display="block",window.scrollTo(0,0)},this.perfPoints.appendChild(e),this.perfPoints.appendChild(i)}};isEmpty=t=>{for(var e in t)if(t.hasOwnProperty(e))return!1;return JSON.stringify(t)===JSON.stringify({})};fillPointsEditModal=(e={})=>{let i,n,s,l,r;const o=document.getElementById("left-table").firstChild,a=document.getElementById("right-table").firstChild;for(;o.childNodes.length>1;)o.childNodes[1].remove();for(;a.childNodes.length>1;)a.childNodes[1].remove();this.totalPointsNum=this.countPointsNum(e),document.getElementById("total-points-num").textContent=this.countPointsNum(e)+" шт.";for(const t in e.leftSide){if(this.isEmpty(e.leftSide[t]))continue;let n,a,d;i=document.createElement("tr"),i.setAttribute("class","left-point-rope"),i.appendChild(document.createElement("td")),s=document.createElement("td"),l=document.createElement("td"),r=document.createElement("td"),n=document.createElement("input"),n.setAttribute("type","number"),n.setAttribute("class","lines"),n.value=e.leftSide[t].stalls.split("/")[0],a=document.createElement("span"),a.textContent="/",d=document.createElement("input"),d.setAttribute("type","number"),d.setAttribute("class","lines"),d.value=e.leftSide[t].stalls.split("/")[1],s.appendChild(n),s.appendChild(a),s.appendChild(d);let c=document.createElement("input");c.setAttribute("type","number"),c.setAttribute("class","meters"),c.value=e.leftSide[t].meters,l.appendChild(c);let h=document.createElement("input");h.setAttribute("type","number"),h.setAttribute("class","machine"),h.value=e.leftSide[t].machine,r.appendChild(h);let p=document.createElement("span");p.setAttribute("class","del-point-rope"),p.textContent="X",p.onclick=t=>{confirm("Удалить эту точку подвеса?")&&(t.target.parentElement.parentElement.remove(),this.totalPointsNum--,this.totalPointsSpan.textContent=this.totalPointsNum+" шт.")},r.appendChild(p),i.appendChild(s),i.appendChild(l),i.appendChild(r),o.appendChild(i)}for(const o in e.rightSide){if(this.isEmpty(e.rightSide[o]))continue;let d,c,h;n=document.createElement("tr"),n.setAttribute("class","right-point-rope"),n.appendChild(document.createElement("td")),s=document.createElement("td"),l=document.createElement("td"),r=document.createElement("td"),d=document.createElement("input"),d.setAttribute("type","number"),d.setAttribute("class","lines"),d.value=e.rightSide[o].stalls.split("/")[0],c=document.createElement("span"),c.thenextContent="/",h=document.createElement("input"),h.setAttribute("type","number"),h.setAttribute("class","lines"),h.value=e.rightSide[o].stalls.split("/")[1],s.appendChild(d),s.appendChild(c),s.appendChild(h);let p=document.createElement("input");p.setAttribute("type","number"),p.setAttribute("class","meters"),p.value=e.rightSide[t].meters,l.appendChild(p);let u=document.createElement("input");u.setAttribute("type","number"),u.setAttribute("class","machine"),u.value=e.rightSide[o].machine,r.appendChild(u);let m=document.createElement("span");m.setAttribute("class","del-point-rope"),m.textContent="X",m.onclick=t=>{confirm("Удалить эту точку подвеса?")&&(t.target.parentElement.parentElement.remove(),this.totalPointsNum--,this.totalPointsSpan.textContent=this.totalPointsNum+" шт."),r.appendChild(m),i.appendChild(s),i.appendChild(l),i.appendChild(r),a.appendChild(n)}}};countPointsNum=t=>{let e=0;if(!t)return 0;for(let i in t.leftSide)this.isEmpty(t.leftSide[i])||e++;for(let i in t.rightSide)this.isEmpty(t.rightSide[i])||e++;return e};fillUserPointsTable=t=>{let e,i,n,s,l,r=document.getElementById("left-usr-table").firstChild,o=document.getElementById("right-usr-table").firstChild;for(;r.childNodes.length>1;)r.childNodes[1].remove();for(;o.childNodes.length>1;)o.childNodes[1].remove();document.getElementById("total-user-points").textContent=this.countPointsNum(t)+" шт.";for(const i in t.leftSide)e=document.createElement("tr"),e.appendChild(document.createElement("td")),n=document.createElement("td"),s=document.createElement("td"),l=document.createElement("td"),n.textContent=t.leftSide[i].stalls,e.appendChild(n),s.textContent=t.leftSide[i].meters,e.appendChild(s),l.textContent=t.leftSide[i].machine,e.appendChild(l),r.appendChild(e);for(const e in t.rightSide)i=document.createElement("tr"),i.appendChild(document.createElement("td")),n=document.createElement("td"),s=document.createElement("td"),l=document.createElement("td"),n.textContent=t.rightSide[e].stalls,i.appendChild(n),s.textContent=t.rightSide[e].meters,i.appendChild(s),l.textContent=t.rightSide[e].machine,i.appendChild(l),o.appendChild(i)};saveEditingPoints=()=>{const e=document.getElementsByClassName("left-point-rope"),i=document.getElementsByClassName("right-point-rope");if(this.pointsData={leftSide:{},rightSide:{}},0!=e.length||0!=i.length){for(let t=0;t<e.length;t++){this.pointsData.leftSide["point"+(t+1)]={};for(let i=1;i<e[t].childNodes.length;i++)if(1==i){let n=e[t].childNodes[i].firstChild,s=e[t].childNodes[i].lastChild;if(!n.value)return n.parentElement.style.backgroundColor="red",n.onclick=()=>{n.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");if(!s.value)return s.parentElement.style.backgroundColor="red",s.onclick=()=>{s.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");this.pointsData.leftSide["point"+(t+1)].stalls=n.value+"/"+s.value}else if(2==i){if(!e[t].childNodes[i].firstChild.value)return e[t].childNodes[i].firstChild.parentElement.style.backgroundColor="red",e[t].childNodes[i].firstChild.onclick=()=>{e[t].childNodes[i].firstChild.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");this.pointsData.leftSide["point"+(t+1)].meters=e[t].childNodes[i].firstChild.value}else 3==i&&(this.pointsData.leftSide["point"+(t+1)].machine=e[t].childNodes[i].firstChild.value)}for(let e=0;e<i.length;e++){this.pointsData.rightSide["point"+(e+1)]={};for(let n=1;n<i[e].childNodes.length;n++)if(1==n){let t=i[e].childNodes[n].firstChild,s=i[e].childNodes[n].lastChild;if(!t.value)return t.parentElement.style.backgroundColor="red",t.onclick=()=>{t.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");if(!s.value)return s.parentElement.style.backgroundColor="red",s.onclick=()=>{s.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");this.pointsData.rightSide["point"+(e+1)].stalls=t.value+"/"+s.value}else if(2==n){if(!i[e].childNodes[n].firstChild.value)return i[e].childNodes[n].firstChild.parentElement.style.backgroundColor="red",i[e].childNodes[n].firstChild.onclick=()=>{i[e].childNodes[n].firstChild.parentElement.style.backgroundColor="initial"},void alert("Пустые поля недопустимы, заполните либо удалите пустые точки подвеса");this.pointsData.rightSide["point"+(e+1)].meters=i[e].childNodes[n].firstChild.value}else 3==n&&(this.pointsData.rightSide["point"+(e+1)].machine=t[e].childNodes[n].firstChild.value)}this.fillEditCardPointsDiv(this.pointsData),this.backgroundPoints.style.display="none"}else this.backgroundPoints.style.display="none"};addAct=()=>{let i=this.perfActs.childNodes.length+1,n=document.createElement("div"),s=document.createElement("span"),l=document.createElement("input"),r=document.createElement("span");n.setAttribute("class","act-line"),s.setAttribute("class","perf-act"),s.setAttribute("id","perf-act"+t),s.textContent=i+":",l.setAttribute("type","text"),l.setAttribute("class","act-time"),l.setAttribute("id","act-time"+i),l.setAttribute("placeholder","1ч 15мин"),r.setAttribute("id","del-act-btn"+t),r.setAttribute("class","del-act-btn"),r.textContent="X",r.onclick=()=>{r.parentElement.remove()},n.appendChild(s),n.appendChild(l),n.appendChild(r),this.perfActs.insertBefore(n,this.perfActs.childNodes[e])};checkActs=()=>{let t=this.perfActs.childNodes.length,e=this.perfActs.childNodes;for(let i=0;i<t;i++)if(!e[i].childNodes[1].value)return e[i].childNodes[1].style.borderColor="red",e[i].childNodes[1].onclick=()=>e[i].childNodes[1].style.borderColor="initial",!1;return!0};inputsValid=()=>this.perfName.value?this.perfType.value?!!this.checkActs()||(this.perfActs.borderColor="red",!1):(this.perfType.style.borderColor="red",!1):(this.perfName.style.borderColor="red",!1);save=async(t,e)=>{if("update"===e||"create"===e){if(this.inputsValid()){let i=this.perfName.value,n=this.perfType.value,s=this.perfUrl.value,l=[],r=this.perfNotes.value;for(let t=0;t<this.perfActs.childNodes.length;t++){if(this.perfActs.childNodes[t].childNodes[1].value.includes(","))return this.perfActs.childNodes[t].childNodes[1].style.borderColor="red";l.push(this.perfActs.childNodes[t].childNodes[1].value)}if(t&&"update"===e){let o={name:i,type:n,imgUrl:s,acts:l,points:this.pointsData,notes:r,perfId:t,action:e};return"OK"==(await request("/performances","POST",o)).statusText?(alert("Спектакль обновлен успешно"),this.backgroundModal.style.display="none",void window.location.reload()):void alert("Ошибка во время сохранения")}if(!t&&"create"==e){let o={name:i,type:n,imgUrl:s,acts:l,points:this.pointsData,notes:r,perfId:t,action:e};if("OK"!=(await request("/performances","POST",o)).statusText)return void alert("Ошибка во время создания");alert("Новый спектакль успешно добавлен"),window.location.reload()}}}else if("remove"===e){let i={perfId:t,action:e};return"OK"==(await request("/performances","POST",i)).statusText?(alert("Спектакль успешно удалён"),void window.location.reload()):void alert("Ошибка удаления")}};addPoint=t=>{const e=document.createElement("tr"),i=document.createElement("span");i.textContent="/";for(let t=0;t<4;t++){let n=document.createElement("td");if(1==t)for(let t=0;t<2;t++){let e=document.createElement("input");e.setAttribute("type","number"),e.setAttribute("class","lines"),1==t&&n.appendChild(i),n.appendChild(e)}else if(2==t){let t=document.createElement("input");t.setAttribute("type","number"),t.setAttribute("class","meters"),n.appendChild(t)}else if(3==t){let t=document.createElement("input"),e=document.createElement("span");e.textContent="X",e.setAttribute("class","del-point-rope"),e.onclick=t=>{confirm("Удалить эту точку подвеса?")&&(t.target.parentElement.parentElement.remove(),this.totalPointsNum--,this.totalPointsSpan.textContent=this.totalPointsNum+" шт.")},t.setAttribute("type","number"),t.setAttribute("class","machine"),n.appendChild(t),n.appendChild(e)}e.appendChild(n)}e.setAttribute("class",t+"-point-rope"),document.getElementById(t+"-table").appendChild(e),this.totalPointsNum++,this.totalPointsSpan.textContent=this.totalPointsNum+" шт."}}async function request(t,e,i){return await fetch(t,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}
//# sourceMappingURL=maps/main.min.js.map
